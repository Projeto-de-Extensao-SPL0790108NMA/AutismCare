{% extends 'base.html' %}

{% block extra_head %}
<!-- Bootstrap Icons (adicione no head do base.html se preferir uma vez só) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  /* Estilos rápidos específicos da página */
  .patient-card { transition: transform .12s ease, box-shadow .12s ease; }
  .patient-card:hover { transform: translateY(-4px); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
  .avatar-circle {
    width:48px; height:48px; border-radius:50%; display:inline-flex;
    align-items:center; justify-content:center; font-weight:700; color:#fff;
    background: linear-gradient(135deg,#6c5ce7,#00b894);
  }
  .fab-new {
    position: fixed; right: 24px; bottom: 24px; z-index: 1050;
    border-radius: 50%; width:56px; height:56px; display:flex; align-items:center;
    justify-content:center; box-shadow: 0 8px 20px rgba(0,0,0,.12);
  }
  .search-input { max-width: 420px; }
  .muted-small { font-size: .85rem; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex align-items-center mb-4">
    <h2 class="me-auto mb-0">
      <i class="bi bi-people-fill text-primary"></i>
      <span class="ms-2">Meus Pacientes</span>
    </h2>

    <!-- Busca client-side -->
    <div class="ms-3 me-2">
      <input id="input-search" type="search" class="form-control search-input" placeholder="Buscar por nome..." aria-label="Buscar pacientes">
    </div>

    <div class="ms-2">
      <a href="{% url 'adicionar_paciente' %}" class="btn btn-primary">
        <i class="bi bi-person-plus-fill"></i> Novo Paciente
      </a>
    </div>
  </div>

  {% if pacientes %}
    <div class="row g-3" id="patients-grid">
      {% for paciente in pacientes %}
        {# Cada card tem data-name para a busca; usamos paciente.sessao_set para info rápida #}
        <div class="col-12 col-md-6 col-lg-4 patient-item" data-name="{{ paciente.nome|lower }}">
          <div class="card patient-card h-100">
            <div class="card-body d-flex gap-3 align-items-start">
              <!-- Avatar com inicial -->
              <div class="avatar-circle me-2 flex-shrink-0">
                {{ paciente.nome|slice:":1"|upper }}
              </div>

              <!-- Conteúdo -->
              <div class="flex-grow-1">
                <div class="d-flex align-items-start">
                  <div class="me-auto">
                    <div class="fw-bold">{{ paciente.nome }}</div>
                    <div class="muted-small">
                      <i class="bi bi-calendar3"></i>
                      {{ paciente.data_nascimento|date:"d/m/Y" }}
                    </div>
                  </div>

                  <!-- Badges / counts -->
                  <div class="text-end">
                    <span class="badge bg-info text-dark" title="Quantidade de sessões">
                      <i class="bi bi-journal-text"></i>
                      {{ paciente.sessao_set.count }}
                    </span>
                    {% with ultima=paciente.sessao_set.last %}
                      {% if ultima %}
                        <div class="muted-small mt-1" title="Última sessão">
                          <i class="bi bi-clock-history"></i>
                          {{ ultima.data_inicio|date:"d/m/Y" }}
                        </div>
                      {% else %}
                        <div class="muted-small mt-1 text-muted">
                          <i class="bi bi-clock"></i> Sem sessões
                        </div>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>

                <!-- Observações/Resumo curto (opcional) -->
                {% comment %} Aqui você pode mostrar mais dados resumidos se tiver campo no modelo {% endcomment %}
                <div class="mt-2 muted-small">
                  <!-- Ex.: último relatório, observação curta -->
                </div>

                <!-- Ações -->
                <div class="mt-3 d-flex gap-2">
                  <a href="{% url 'iniciar_sessao' paciente.id %}" class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="Iniciar sessão">
                    <i class="bi bi-play-circle"></i>
                  </a>

                  <a href="{% url 'historico_sessoes' paciente.id %}" class="btn btn-sm btn-secondary" data-bs-toggle="tooltip" title="Histórico">
                    <i class="bi bi-clock-history"></i>
                  </a>

                  <a href="{% url 'relatorio_paciente' paciente.id %}" class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="Relatório">
                    <i class="bi bi-bar-chart-line"></i>
                  </a>

                  <!-- Dropdown com ações extras -->
                  <div class="btn-group ms-auto">
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <a class="dropdown-item" href="{% url 'editar_paciente' paciente.id %}">
                          <i class="bi bi-pencil-square me-2"></i> Editar
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item text-danger" href="{% url 'excluir_paciente' paciente.id %}" data-confirm="Confirma exclusão do paciente {{ paciente.nome }}?">
                          <i class="bi bi-trash-fill me-2"></i> Excluir
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

  {% else %}
    <div class="alert alert-warning text-center" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i> Nenhum paciente encontrado.
    </div>
  {% endif %}

  <!-- FAB Novo paciente -->
  <a href="{% url 'adicionar_paciente' %}" class="btn btn-primary fab-new" aria-label="Novo paciente">
    <i class="bi bi-plus-lg" style="font-size: 1.25rem;"></i>
  </a>
</div>

<!-- Scripts específicos da página -->
<script>
  // Busca client-side simples
  (function() {
    const input = document.getElementById('input-search');
    if (!input) return;
    input.addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      const items = document.querySelectorAll('.patient-item');
      items.forEach(it => {
        const name = it.getAttribute('data-name') || '';
        it.style.display = name.includes(q) ? '' : 'none';
      });
    });
  })();

  // Confirm delete
  (function() {
    document.addEventListener('click', function(e) {
      const el = e.target.closest('a[data-confirm]');
      if (!el) return;
      e.preventDefault();
      const msg = el.getAttribute('data-confirm') || 'Confirmar?';
      if (confirm(msg)) {
        window.location = el.href;
      }
    });
  })();

  // Bootstrap tooltips init (garanta que bootstrap.bundle.js está incluído no base.html)
  (function() {
    if (typeof bootstrap !== 'undefined') {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }
  })();
</script>
{% endblock %}
